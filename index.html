<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£²æ–™ç´€éŒ„åæŸ¥ç³»çµ± v2.4 (é›²ç«¯åŒæ­¥ç‰ˆ)</title>
    <style>
        :root { 
            --primary-color: #27ae60; /* ç¶ è‰² - å¥½å– */
            --danger-color: #e74c3c;  /* ç´…è‰² - è¸©é›· */
            --neutral-color: #95a5a6; /* ç°è‰² - é‚„å¥½ */
            --accent-color: #f1c40f; 
            --cloud-color: #3498db;   /* è—è‰² - é›²ç«¯è¼‰å…¥ */
        }
        body { font-family: -apple-system, system-ui, sans-serif; background-color: #f4f6f8; padding: 15px; margin: 0; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        h2 { text-align: center; color: #333; margin-top: 0; }
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px; color: #666; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); outline: none; }
        .row { display: flex; gap: 10px; }
        button { width: 100%; padding: 16px; background: var(--primary-color); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background 0.2s; }
        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .btn-cloud { background: var(--cloud-color); margin-top: 10px; font-size: 16px; }
        .btn-cloud:hover { background: #2980b9; }

        /* æœå°‹åæŸ¥å€ */
        .search-section { margin-top: 30px; border-top: 2px dashed #eee; padding-top: 20px; }
        .search-box { background-color: #fff9e6; border: 2px solid var(--accent-color); font-weight: bold; }
        
        /* ç´€éŒ„å¡ç‰‡ */
        .record-list { margin-top: 15px; }
        .record-item { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 12px; border: 1px solid #eee; position: relative; }
        
        /* æ ¹æ“šè©•åƒ¹æ”¹è®Šé‚Šæ¡†é¡è‰² */
        .record-item.good { border-left: 8px solid var(--primary-color); }
        .record-item.neutral { border-left: 8px solid var(--neutral-color); }
        .record-item.bad { border-left: 8px solid var(--danger-color); }
        
        .item-title { font-weight: bold; font-size: 18px; color: #111; }
        .item-info { font-size: 14px; color: #555; margin-top: 3px; }
        .item-note { font-size: 13px; color: #777; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 8px; border-left: 2px solid #ddd; }
        .action-buttons { position: absolute; right: 12px; top: 12px; display: flex; gap: 15px; }
        .action-btn { cursor: pointer; font-size: 13px; font-weight: bold; }
        .action-btn.edit { color: var(--cloud-color); }
        .action-btn.delete { color: #ccc; }
        .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; background: #eee; margin-right: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ¥¤ é£²æ–™é–‹ç™¼ç­†è¨˜</h2>
    
    <div class="form-group"><label>é£²æ–™åº—</label><input type="text" id="shopName" placeholder="ä¾‹å¦‚ï¼šäº”ååµã€éº»å¤"></div>
    <div class="form-group"><label>åœ°é»</label><input type="text" id="location" placeholder="ä¾‹å¦‚ï¼šä¸‰é‡è‡ªå¼·åº—"></div>
    <div class="form-group"><label>å“é …</label><input type="text" id="drinkName" placeholder="ä¾‹å¦‚ï¼šé‡‘è±é›™Q"></div>
    
    <div class="row">
        <div class="form-group" style="flex:1.2">
            <label>ç”œåº¦</label>
            <select id="sugar">
                <option value="ç„¡ç³–">ç„¡ç³–</option>
                <option value="ä¸€åˆ†ç³–" selected>ä¸€åˆ†ç³–</option>
                <option value="å¾®ç³–(3åˆ†)">å¾®ç³–(3åˆ†)</option>
                <option value="åŠç³–(5åˆ†)">åŠç³–(5åˆ†)</option>
                <option value="å°‘ç³–(7åˆ†)">å°‘ç³–(7åˆ†)</option>
                <option value="æ­£å¸¸ç³–">æ­£å¸¸ç³–</option>
            </select>
        </div>
        <div class="form-group" style="flex:1">
            <label>å†°å¡Š</label>
            <select id="ice">
                <option value="å¾®å†°" selected>å¾®å†°</option>
                <option value="å°‘å†°">å°‘å†°</option>
                <option value="å»å†°">å»å†°</option>
                <option value="æ­£å¸¸">æ­£å¸¸</option>
                <option value="ç†±">ç†±</option>
            </select>
        </div>
    </div>

    <div class="form-group">
        <label>è©•åƒ¹</label>
        <select id="rating">
            <option value="ğŸ‘ å¥½å–">ğŸ‘ å¥½å–ï¼Œä¸‹æ¬¡å†é»</option>
            <option value="ğŸ‘Œ é‚„å¥½">ğŸ‘Œ é‚„å¥½ï¼Œä¸­è¦ä¸­çŸ©</option>
            <option value="ğŸ‘ è¸©é›·">ğŸ‘ é›£å–ï¼Œåƒè¬åˆ¥é»</option>
        </select>
    </div>

    <div class="form-group"><label>å‚™è¨»å¿ƒå¾—</label><textarea id="note" rows="2" placeholder="å£æ„Ÿåˆ†äº«ã€çç Qåº¦..."></textarea></div>

    <div style="display: flex; gap: 10px;">
        <button id="saveBtn" onclick="saveRecord()" style="flex: 2;">å„²å­˜ç´€éŒ„ä¸¦ä¸Šå‚³é›²ç«¯</button>
        <button id="cancelBtn" onclick="cancelEdit()" style="flex: 1; display: none; background-color: #95a5a6;">å–æ¶ˆ</button>
    </div>
    
    <!-- æ–°å¢ï¼šå¾é›²ç«¯è¼‰å…¥æŒ‰éˆ• -->
    <button id="loadBtn" class="btn-cloud" onclick="loadFromCloud()">ğŸ“¥ å¾é›²ç«¯è¼‰å…¥æœ€æ–°ç´€éŒ„</button>

    <!-- åæŸ¥å€ -->
    <div class="search-section">
        <label>ğŸ” å¿«é€ŸåæŸ¥æ­·å² (è¼¸å…¥é—œéµå­—)</label>
        <input type="text" id="searchInput" class="search-box" placeholder="æœå°‹åº—åã€å“é …..." onkeyup="displayRecords()">
        
        <div id="recordList" class="record-list"></div>
    </div>
</div>

<script>
    // --- é‡è¦ï¼šè²¼ä¸Šä½ çš„ Google Apps Script URL ---
    const WEB_APP_URL = "åœ¨æ­¤è²¼ä¸Šä½ çš„GASç¶²å€"; 
    let currentEditId = null;

    window.onload = displayRecords;

    async function saveRecord() {
        const btn = document.getElementById('saveBtn');
        const record = {
            shop: document.getElementById('shopName').value,
            loc: document.getElementById('location').value,
            drink: document.getElementById('drinkName').value,
            sugar: document.getElementById('sugar').value,
            ice: document.getElementById('ice').value,
            rating: document.getElementById('rating').value,
            note: document.getElementById('note').value,
            date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString('zh-TW', {hour12: false}).slice(0, 5)
        };

        if(!record.shop || !record.drink) return alert('åº—åèˆ‡å“é …æ˜¯å¿…å¡«çš„å–”ï¼');

        if (currentEditId) {
            // åŸ·è¡Œä¿®æ”¹é‚è¼¯ (åƒ…æ›´æ–°æ‰‹æ©Ÿæœ¬åœ°é¡¯ç¤º)
            let records = JSON.parse(localStorage.getItem('myDrinkLogs') || '[]');
            let index = records.findIndex(r => r.id === currentEditId);
            if(index !== -1) {
                record.id = currentEditId;
                record.date = records[index].date + " (å·²ç·¨è¼¯)"; 
                records[index] = record;
                localStorage.setItem('myDrinkLogs', JSON.stringify(records));
                alert('æœ¬åœ°ç´€éŒ„å·²æ›´æ–°ï¼\n\n(æº«é¦¨æç¤ºï¼šæ­¤ä¿®æ”¹åƒ…æ›´æ–°æ‚¨æ‰‹æ©Ÿçš„ä»‹é¢ï¼ŒGoogle Sheets é›²ç«¯è³‡æ–™åº«éœ€æ‰‹å‹•èª¿æ•´)');
            }
            cancelEdit();
            displayRecords();
            return;
        }

        btn.disabled = true;
        btn.innerText = "é€£ç·šé›²ç«¯ä¸­...";

        // é›²ç«¯åŒæ­¥ (POST)
        if(WEB_APP_URL !== "åœ¨æ­¤è²¼ä¸Šä½ çš„GASç¶²å€") {
            try {
                await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(record) });
            } catch (e) { 
                console.error("é›²ç«¯åŒæ­¥å¤±æ•—", e); 
            }
        }

        // æœ¬åœ°å„²å­˜ (ä¾›å¿«é€ŸåæŸ¥)
        let records = JSON.parse(localStorage.getItem('myDrinkLogs') || '[]');
        record.id = Date.now();
        records.unshift(record); // æŠŠæ–°ç´€éŒ„å¡åˆ°æœ€å‰é¢
        localStorage.setItem('myDrinkLogs', JSON.stringify(records));

        // é‡ç½® UI
        document.getElementById('drinkName').value = '';
        document.getElementById('note').value = '';
        document.getElementById('rating').value = 'ğŸ‘ å¥½å–'; 
        
        displayRecords();
        btn.disabled = false;
        btn.innerText = "å„²å­˜ç´€éŒ„ä¸¦ä¸Šå‚³é›²ç«¯";
    }

    // --- æ–°å¢ï¼šå¾é›²ç«¯è¼‰å…¥æœ€æ–°ç´€éŒ„ ---
    async function loadFromCloud() {
        if(WEB_APP_URL === "åœ¨æ­¤è²¼ä¸Šä½ çš„GASç¶²å€") {
            return alert("è«‹å…ˆåœ¨ç¨‹å¼ç¢¼å…§è¨­å®š GAS ç¶²å€ï¼");
        }

        const btn = document.getElementById('loadBtn');
        btn.disabled = true;
        btn.innerText = "æ­£åœ¨å¾ Google Sheets è¼‰å…¥... â³";

        try {
            // ç™¼é€ GET è«‹æ±‚å»æŠ“å– GAS åå‡ºä¾†çš„ JSON
            const response = await fetch(WEB_APP_URL);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const cloudRecords = await response.json();

            if (cloudRecords && cloudRecords.length > 0) {
                // å°‡é›²ç«¯è³‡æ–™è¦†è“‹æœ¬åœ°è¨˜éŒ„
                localStorage.setItem('myDrinkLogs', JSON.stringify(cloudRecords));
                displayRecords();
                alert(`âœ… åŒæ­¥æˆåŠŸï¼å…±è¼‰å…¥äº† ${cloudRecords.length} ç­†æœ€æ–°ç´€éŒ„ã€‚`);
            } else {
                alert('é›²ç«¯ç›®å‰æ²’æœ‰ä»»ä½•ç´€éŒ„ã€‚');
            }
        } catch (error) {
            console.error("è¼‰å…¥å¤±æ•—", error);
            alert("è¼‰å…¥å¤±æ•— âŒ\nè«‹ç¢ºèªæ‚¨çš„ Apps Script æ˜¯å¦å·²æ–°å¢ doGet å‡½æ•¸ï¼Œä¸”éƒ¨ç½²æ¬Šé™è¨­ç‚ºã€Œæ‰€æœ‰äººã€ã€‚");
        } finally {
            btn.disabled = false;
            btn.innerText = "ğŸ“¥ å¾é›²ç«¯è¼‰å…¥æœ€æ–°ç´€éŒ„";
        }
    }

    function editRecord(id) {
        let records = JSON.parse(localStorage.getItem('myDrinkLogs') || '[]');
        let record = records.find(r => r.id === id);
        if(!record) return;

        // å°‡è³‡æ–™å¡«å›ä¸Šæ–¹è¡¨å–®
        document.getElementById('shopName').value = record.shop;
        document.getElementById('location').value = record.loc || '';
        document.getElementById('drinkName').value = record.drink;
        document.getElementById('sugar').value = record.sugar;
        document.getElementById('ice').value = record.ice;
        document.getElementById('rating').value = record.rating;
        document.getElementById('note').value = record.note || '';

        // æ”¹è®Š UI ç‹€æ…‹é€²å…¥ç·¨è¼¯æ¨¡å¼
        currentEditId = id;
        document.getElementById('saveBtn').innerText = "ğŸ’¾ æ›´æ–°æœ¬åœ°ç´€éŒ„";
        document.getElementById('saveBtn').style.backgroundColor = "#3498db";
        document.getElementById('cancelBtn').style.display = "block";
        document.getElementById('loadBtn').style.display = "none"; // ç·¨è¼¯æ™‚éš±è—è¼‰å…¥æŒ‰éˆ•
        
        // è‡ªå‹•æ²å‹•åˆ°æœ€ä¸Šæ–¹æ–¹ä¾¿ä¿®æ”¹
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function cancelEdit() {
        currentEditId = null;
        document.getElementById('drinkName').value = '';
        document.getElementById('note').value = '';
        document.getElementById('rating').value = 'ğŸ‘ å¥½å–'; 
        
        // æ¢å¾©æŒ‰éˆ•é è¨­æ¨£å¼
        document.getElementById('saveBtn').innerText = "å„²å­˜ç´€éŒ„ä¸¦ä¸Šå‚³é›²ç«¯";
        document.getElementById('saveBtn').style.backgroundColor = "var(--primary-color)";
        document.getElementById('cancelBtn').style.display = "none";
        document.getElementById('loadBtn').style.display = "block";
    }

    function displayRecords() {
        const list = document.getElementById('recordList');
        const term = document.getElementById('searchInput').value.toLowerCase();
        const records = JSON.parse(localStorage.getItem('myDrinkLogs') || '[]');
        
        // æ ¹æ“šæœå°‹æ¡†éæ¿¾ç´€éŒ„
        const filtered = records.filter(item => 
            item.shop.toLowerCase().includes(term) || 
            item.drink.toLowerCase().includes(term) || 
            (item.note && item.note.toLowerCase().includes(term))
        );

        list.innerHTML = '';
        if (filtered.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px;">å°šç„¡ç›¸ç¬¦ç´€éŒ„</div>';
            return;
        }

        filtered.forEach(item => {
            // åˆ¤æ–·è©•åƒ¹é¡è‰²
            let ratingClass = 'good';
            if (item.rating.includes('ğŸ‘')) {
                ratingClass = 'bad';
            } else if (item.rating.includes('ğŸ‘Œ')) {
                ratingClass = 'neutral';
            }

            const div = document.createElement('div');
            div.className = `record-item ${ratingClass}`;
            div.innerHTML = `
                <div class="action-buttons">
                    <span class="action-btn edit" onclick="editRecord(${item.id})">ç·¨è¼¯</span>
                    <span class="action-btn delete" onclick="deleteRecord(${item.id})">åˆªé™¤</span>
                </div>
                <div class="item-title">${item.drink}</div>
                <div class="item-info">ğŸ“ ${item.shop} <span style="color:#999">(${item.loc || 'æœªå¡«å¯«åœ°é»'})</span></div>
                <div style="margin-top:5px;">
                    <span class="tag">${item.sugar}</span>
                    <span class="tag">${item.ice}</span>
                    <span class="tag">${item.rating}</span>
                </div>
                ${item.note ? `<div class="item-note">${item.note}</div>` : ''}
                <div style="font-size: 10px; color: #ccc; margin-top: 10px;">ç´€éŒ„æ—¥æœŸ: ${item.date}</div>
            `;
            list.appendChild(div);
        });
    }

    function deleteRecord(id) {
        if(confirm('ç¢ºå®šè¦å¾æ‰‹æ©Ÿæ¸…é™¤é€™ç­†é¡¯ç¤ºå—ï¼Ÿ(ä¸æœƒå½±éŸ¿ Google Sheet é›²ç«¯è³‡æ–™)')) {
            let records = JSON.parse(localStorage.getItem('myDrinkLogs') || '[]');
            records = records.filter(r => r.id !== id);
            localStorage.setItem('myDrinkLogs', JSON.stringify(records));
            displayRecords();
        }
    }
</script>

</body>
</html>
