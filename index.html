<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£²æ–™ç´€éŒ„</title>
    <style>
        :root { 
            --primary-color: #27ae60; 
            --danger-color: #e74c3c;  
            --neutral-color: #95a5a6; 
            --accent-color: #f1c40f; 
            --cloud-color: #3498db;   
        }
        body { font-family: -apple-system, system-ui, sans-serif; background-color: #f4f6f8; padding: 15px; margin: 0; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        h2 { text-align: center; color: #333; margin-top: 0; }
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px; color: #666; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); outline: none; }
        .row { display: flex; gap: 10px; }
        button { width: 100%; padding: 16px; background: var(--primary-color); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background 0.2s; }
        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .btn-cloud { background: var(--cloud-color); margin-top: 10px; font-size: 16px; }
        .btn-cloud:hover { background: #2980b9; }

        .search-section { margin-top: 30px; border-top: 2px dashed #eee; padding-top: 20px; }
        .search-box { background-color: #fff9e6; border: 2px solid var(--accent-color); font-weight: bold; }
        
        .record-list { margin-top: 15px; }
        .record-item { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 12px; border: 1px solid #eee; position: relative; }
        
        .record-item.good { border-left: 8px solid var(--primary-color); }
        .record-item.neutral { border-left: 8px solid var(--neutral-color); }
        .record-item.bad { border-left: 8px solid var(--danger-color); }
        
        .item-title { font-weight: bold; font-size: 18px; color: #111; }
        .item-info { font-size: 14px; color: #555; margin-top: 3px; }
        .item-note { font-size: 13px; color: #777; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 8px; border-left: 2px solid #ddd; }
        .action-buttons { position: absolute; right: 12px; top: 12px; display: flex; gap: 15px; }
        .action-btn { cursor: pointer; font-size: 13px; font-weight: bold; }
        .action-btn.edit { color: var(--cloud-color); }
        .action-btn.delete { color: #ccc; }
        .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; background: #eee; margin-right: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ¥¤ é£²æ–™ç­†è¨˜</h2>
    
    <div class="form-group"><label>é£²æ–™åº—</label><input type="text" id="shopName" placeholder="ä¾‹å¦‚ï¼šäº”ååµã€éº»å¤"></div>
    <div class="form-group"><label>åœ°é»</label><input type="text" id="location" placeholder="ä¾‹å¦‚ï¼šä¸‰é‡è‡ªå¼·åº—"></div>
    <div class="form-group"><label>å“é …</label><input type="text" id="drinkName" placeholder="ä¾‹å¦‚ï¼šé‡‘è±é›™Q"></div>
    
    <div class="row">
        <div class="form-group" style="flex:1.2">
            <label>ç”œåº¦</label>
            <select id="sugar">
                <option value="ç„¡ç³–">ç„¡ç³–</option>
                <option value="ä¸€åˆ†ç³–" selected>ä¸€åˆ†ç³–</option>
                <option value="å¾®ç³–(3åˆ†)">å¾®ç³–(3åˆ†)</option>
                <option value="åŠç³–(5åˆ†)">åŠç³–(5åˆ†)</option>
                <option value="å°‘ç³–(7åˆ†)">å°‘ç³–(7åˆ†)</option>
                <option value="æ­£å¸¸ç³–">æ­£å¸¸ç³–</option>
            </select>
        </div>
        <div class="form-group" style="flex:1">
            <label>å†°å¡Š</label>
            <select id="ice">
                <option value="å¾®å†°" selected>å¾®å†°</option>
                <option value="å°‘å†°">å°‘å†°</option>
                <option value="å»å†°">å»å†°</option>
                <option value="æ­£å¸¸">æ­£å¸¸</option>
                <option value="ç†±">ç†±</option>
            </select>
        </div>
    </div>

    <div class="form-group">
        <label>è©•åƒ¹</label>
        <select id="rating">
            <option value="ğŸ‘ å¥½å–">ğŸ‘ å¥½å–ï¼Œä¸‹æ¬¡å†é»</option>
            <option value="ğŸ‘Œ é‚„å¥½">ğŸ‘Œ é‚„å¥½ï¼Œä¸­è¦ä¸­çŸ©</option>
            <option value="ğŸ‘ è¸©é›·">ğŸ‘ é›£å–ï¼Œåƒè¬åˆ¥é»</option>
        </select>
    </div>

    <div class="form-group"><label>å‚™è¨»å¿ƒå¾—</label><textarea id="note" rows="2" placeholder="å£æ„Ÿåˆ†äº«ã€çç Qåº¦..."></textarea></div>

    <div style="display: flex; gap: 10px;">
        <button id="saveBtn" onclick="saveRecord()" style="flex: 2;">å„²å­˜ç´€éŒ„ä¸¦ä¸Šå‚³é›²ç«¯</button>
        <button id="cancelBtn" onclick="cancelEdit()" style="flex: 1; display: none; background-color: #95a5a6;">å–æ¶ˆ</button>
    </div>
    
    <button id="loadBtn" class="btn-cloud" onclick="loadFromCloud()">ğŸ“¥ å¾é›²ç«¯è¼‰å…¥æœ€æ–°ç´€éŒ„</button>

    <div class="search-section">
        <label>ğŸ” å¿«é€ŸåæŸ¥æ­·å² (è¼¸å…¥é—œéµå­—)</label>
        <input type="text" id="searchInput" class="search-box" placeholder="æœå°‹åº—åã€å“é …..." onkeyup="displayRecords()">
        
        <div id="recordList" class="record-list"></div>
    </div>
</div>

<script>
    // --- é‡è¦ï¼šè²¼ä¸Šä½ çš„ Google Apps Script URL ---
    const WEB_APP_URL = "åœ¨æ­¤è²¼ä¸Šä½ çš„GASç¶²å€"; 
    let currentEditId = null;

    window.onload = displayRecords;

    async function saveRecord() {
        const btn = document.getElementById('saveBtn');
        const record = {
            shop: document.getElementById('shopName').value,
            loc: document.getElementById('location').value,
            drink: document.getElementById('drinkName').value,
            sugar: document.getElementById('sugar').value,
            ice: document.getElementById('ice').value,
            rating: document.getElementById('rating').value,
            note: document.getElementById('note').value
        };

        if(!record.shop || !record.drink) return alert('åº—åèˆ‡å“é …æ˜¯å¿…å¡«çš„å–”ï¼');

        btn.disabled = true;

        if (currentEditId) {
            // -- ä¿®æ”¹æ¨¡å¼ --
            let records = JSON.parse(localStorage.getItem('myDrinkLogs') || '[]');
            let index = records.findIndex(r => r.id === currentEditId);
            
            if(index !== -1) {
                btn.innerText = "é›²ç«¯åŒæ­¥æ›´æ–°ä¸­...";
                record.id = currentEditId;
                record.action = "update"; // å‘Šè¨´ GAS é€™æ˜¯æ›´æ–°
                record.originalDate = records[index].date; // æä¾›èˆŠçš„æ—¥æœŸä¾› GAS å°‹æ‰¾
                record.date = records[index].date; // ä¿æŒåŸæœ¬ç´€éŒ„çš„æ—¥æœŸæ™‚é–“ä¸è®Š

                if(WEB_APP_URL !== "åœ¨æ­¤è²¼ä¸Šä½ çš„GASç¶²å€") {
                    try {
                        await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(record) });
                    } catch (e) { console.error("é›²ç«¯æ›´æ–°å¤±æ•—", e); }
                }

                records[index] = record;
                localStorage.setItem('myDrinkLogs', JSON.stringify(records));
                alert('âœ… ç´€éŒ„å·²æˆåŠŸæ›´æ–°ï¼Œä¸¦åŒæ­¥è‡³é›²ç«¯è³‡æ–™åº«ï¼');
            }
            cancelEdit();
            displayRecords();
            btn.disabled = false;
            return;
        }

        // -- æ–°å¢æ¨¡å¼ --
        btn.innerText = "é€£ç·šé›²ç«¯ä¸­...";
        record.id = Date.now();
        record.action = "add";
        record.date = new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString('zh-TW', {hour12: false}).slice(0, 5);

        if(WEB_APP_URL !== "åœ¨æ­¤è²¼ä¸Šä½ çš„GASç¶²å€") {
            try {
                await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(record) });
            } catch (e) { 
                console.error("é›²ç«¯åŒæ­¥å¤±æ•—", e); 
            }
        }

        let records = JSON.parse(localStorage.getItem('myDrinkLogs') || '[]');
        records.unshift(record);
        localStorage.setItem('myDrinkLogs', JSON.stringify(records));

        document.getElementById('drinkName').value = '';
        document.getElementById('note').value = '';
        document.getElementById('rating').value = 'ğŸ‘ å¥½å–'; 
        
        displayRecords();
        btn.disabled = false;
        btn.innerText = "å„²å­˜ç´€éŒ„ä¸¦ä¸Šå‚³é›²ç«¯";
    }

    async function loadFromCloud() {
        if(WEB_APP_URL === "åœ¨æ­¤è²¼ä¸Šä½ çš„GASç¶²å€") return alert("è«‹å…ˆåœ¨ç¨‹å¼ç¢¼å…§è¨­å®š GAS ç¶²å€ï¼");

        const btn = document.getElementById('loadBtn');
        btn.disabled = true;
        btn.innerText = "æ­£åœ¨å¾ Google Sheets è¼‰å…¥... â³";

        try {
            // å¢åŠ å¿«å–æ§åˆ¶èˆ‡é‡æ–°å°å‘è¨­å®šï¼Œç¢ºä¿æ‹‰åˆ°æœ€æ–°è³‡æ–™
            const response = await fetch(WEB_APP_URL, {
                method: 'GET',
                redirect: 'follow', 
                cache: 'no-cache' // å¼·åˆ¶ä¸ä½¿ç”¨å¿«å–
            });
            
            const textData = await response.text(); // å…ˆè½‰ç´”æ–‡å­—ï¼Œæ–¹ä¾¿å ±éŒ¯æ™‚æŸ¥çœ‹
            
            let cloudRecords;
            try {
                cloudRecords = JSON.parse(textData);
            } catch (parseError) {
                console.error("å›å‚³å…§å®¹ç„¡æ³•è§£æï¼š", textData);
                throw new Error("å›å‚³æ ¼å¼éŒ¯èª¤ï¼è«‹ç¢ºèª GAS å·²é‡æ–°éƒ¨ç½²ç‚ºã€Œæ–°ç‰ˆæœ¬ã€ã€‚");
            }

            if (cloudRecords && Array.isArray(cloudRecords) && cloudRecords.length > 0) {
                localStorage.setItem('myDrinkLogs', JSON.stringify(cloudRecords));
                displayRecords();
                alert(`âœ… åŒæ­¥æˆåŠŸï¼å…±è¼‰å…¥äº† ${cloudRecords.length} ç­†æœ€æ–°ç´€éŒ„ã€‚`);
            } else {
                alert('é›²ç«¯ç›®å‰æ²’æœ‰ä»»ä½•ç´€éŒ„ï¼Œæˆ–æ˜¯è®€å–åˆ°ç©ºé™£åˆ—ã€‚');
            }
        } catch (error) {
            console.error("è¼‰å…¥å¤±æ•—", error);
            alert("è¼‰å…¥å¤±æ•— âŒ\néŒ¯èª¤è¨Šæ¯ï¼š" + error.message + "\n\nå¸¸è¦‹åŸå› ï¼š\n1. æ‚¨å¯èƒ½å¿˜è¨˜å°‡ GAS é‡æ–°éƒ¨ç½²ç‚ºã€Œæ–°ç‰ˆæœ¬ã€\n2. éƒ¨ç½²æ¬Šé™æœªè¨­ç‚ºã€Œæ‰€æœ‰äººã€");
        } finally {
            btn.disabled = false;
            btn.innerText = "ğŸ“¥ å¾é›²ç«¯è¼‰å…¥æœ€æ–°ç´€éŒ„";
        }
    }

    function editRecord(id) {
        let records = JSON.parse(localStorage.getItem('myDrinkLogs') || '[]');
        let record = records.find(r => r.id === id);
        if(!record) return;

        document.getElementById('shopName').value = record.shop;
        document.getElementById('location').value = record.loc || '';
        document.getElementById('drinkName').value = record.drink;
        document.getElementById('sugar').value = record.sugar;
        document.getElementById('ice').value = record.ice;
        document.getElementById('rating').value = record.rating;
        document.getElementById('note').value = record.note || '';

        currentEditId = id;
        document.getElementById('saveBtn').innerText = "ğŸ’¾ å„²å­˜ä¿®æ”¹ä¸¦åŒæ­¥é›²ç«¯";
        document.getElementById('saveBtn').style.backgroundColor = "#3498db";
        document.getElementById('cancelBtn').style.display = "block";
        document.getElementById('loadBtn').style.display = "none";
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function cancelEdit() {
        currentEditId = null;
        document.getElementById('drinkName').value = '';
        document.getElementById('note').value = '';
        document.getElementById('rating').value = 'ğŸ‘ å¥½å–'; 
        
        document.getElementById('saveBtn').innerText = "å„²å­˜ç´€éŒ„ä¸¦ä¸Šå‚³é›²ç«¯";
        document.getElementById('saveBtn').style.backgroundColor = "var(--primary-color)";
        document.getElementById('cancelBtn').style.display = "none";
        document.getElementById('loadBtn').style.display = "block";
    }

    function displayRecords() {
        const list = document.getElementById('recordList');
        const term = document.getElementById('searchInput').value.toLowerCase();
        const records = JSON.parse(localStorage.getItem('myDrinkLogs') || '[]');
        
        const filtered = records.filter(item => 
            item.shop.toLowerCase().includes(term) || 
            item.drink.toLowerCase().includes(term) || 
            (item.note && item.note.toLowerCase().includes(term))
        );

        list.innerHTML = '';
        if (filtered.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px;">å°šç„¡ç›¸ç¬¦ç´€éŒ„</div>';
            return;
        }

        filtered.forEach(item => {
            let ratingClass = 'good';
            if (item.rating.includes('ğŸ‘')) ratingClass = 'bad';
            else if (item.rating.includes('ğŸ‘Œ')) ratingClass = 'neutral';

            const div = document.createElement('div');
            div.className = `record-item ${ratingClass}`;
            div.innerHTML = `
                <div class="action-buttons">
                    <span class="action-btn edit" onclick="editRecord(${item.id})">ç·¨è¼¯</span>
                    <span class="action-btn delete" onclick="deleteRecord(${item.id})">åˆªé™¤</span>
                </div>
                <div class="item-title">${item.drink}</div>
                <div class="item-info">ğŸ“ ${item.shop} <span style="color:#999">(${item.loc || 'æœªå¡«å¯«åœ°é»'})</span></div>
                <div style="margin-top:5px;">
                    <span class="tag">${item.sugar}</span>
                    <span class="tag">${item.ice}</span>
                    <span class="tag">${item.rating}</span>
                </div>
                ${item.note ? `<div class="item-note">${item.note}</div>` : ''}
                <div style="font-size: 10px; color: #ccc; margin-top: 10px;">ç´€éŒ„æ—¥æœŸ: ${item.date}</div>
            `;
            list.appendChild(div);
        });
    }

    async function deleteRecord(id) {
        if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ\n(é€™å°‡åŒæ™‚åˆªé™¤æ‰‹æ©Ÿèˆ‡ Google Sheets é›²ç«¯çš„è³‡æ–™)')) {
            let records = JSON.parse(localStorage.getItem('myDrinkLogs') || '[]');
            let recordToDelete = records.find(r => r.id === id);
            
            // å…ˆå¾æœ¬åœ°ç§»é™¤ä»¥é”åˆ°å³æ™‚åæ‡‰
            records = records.filter(r => r.id !== id);
            localStorage.setItem('myDrinkLogs', JSON.stringify(records));
            displayRecords();

            // å‘¼å«é›²ç«¯é€²è¡Œåˆªé™¤
            if(recordToDelete && WEB_APP_URL !== "https://script.google.com/macros/s/AKfycbwWzUhwBnoYacz-Ncj0npr1ZpKPc7eXqiL6DLJcGsl93URkQkBnL5uSirAGydxcHPVMYw/exec") {
                try {
                    const payload = {
                        action: 'delete',
                        id: recordToDelete.id,
                        originalDate: recordToDelete.date
                    };
                    await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
                } catch (e) {
                    console.error("é›²ç«¯åˆªé™¤å¤±æ•—", e);
                }
            }
        }
    }
</script>

</body>
</html>

